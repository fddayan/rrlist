#!/usr/bin/env ruby

require File.expand_path('../../lib/rrlist/rrcomposite', __FILE__)

# puts "Rrdtool #{ARGV}"
command = ARGV.shift

case command
  when "create"
    file_name = ARGV.shift

    if File.exists?(file_name)
      puts "File '#{file_name}' already exists"
      return
    end

    size = ARGV.shift.to_i

    data = [
      {:size => size, :range => 1},
      {:size => size, :range => 60,         :before_add => :average},
      {:size => size, :range => (60*60),    :before_add => :average},
      {:size => size, :range => (60*60*24), :before_add => :average},
    ]

    puts "Initializing database"
    rr_composite = RRComposite.new(data)
    puts "Creating database to '#{file_name}'"
    rr_composite.persist(file_name)

  when "update"
    file_name = ARGV.shift
    index_code = ARGV.shift
    value = ARGV.shift.to_f

    index = case index_code
              when "now" then Time.now.to_i
              else index.to_i
            end

    puts "Updating database #{file_name} with #{value} at #{index}"

    rr_composite = RRComposite.load(file_name)

    rr_composite.add_at(index,value)
    rr_composite.persist(file_name)

    puts "Updated"

  when "display"
    file_name = ARGV.shift
    rr_list_index = ARGV.shift.to_i

    rr_composite = RRComposite.load(file_name)

    rr_composite.rr_lists[rr_list_index].each_with_index do |value, index|
      puts "#{index} : #{value}"
    end
end


